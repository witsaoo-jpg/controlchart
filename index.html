<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Control Chart System - Dynamic HA</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Prompt', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding-bottom: 30px; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); width: 100%; max-width: 500px; text-align: center; }
        .main-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin: 20px auto; padding: 30px; }
        .header-title { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .agency-badge { display: inline-block; background: #e0e7ff; color: #4f46e5; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); background: white; margin-bottom: 20px; }
        .card-header-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0 !important; font-weight: 600; padding: 15px 20px; }
        .btn-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 10px 25px; font-weight: 500; transition: all 0.3s ease; }
        .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); color: white; }
        .btn-pdf { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; padding: 8px 20px; font-weight: 500; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 5px solid #667eea; }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #667eea; }
        .nav-pills .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white !important;}
        .nav-pills .nav-link { color: #667eea; font-weight: 500; border-radius: 10px; margin: 0 5px; cursor: pointer; }
        .chart-container { position: relative; height: 400px; margin-top: 20px; }
        .filter-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .credit-footer { text-align: center; margin-top: 25px; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; }
        .credit-footer a { color: white; text-decoration: none; font-weight: 600; }
        .admin-filter-box { background: #fff3cd; border: 1px solid #ffe69c; border-radius: 10px; padding: 10px 20px; display: inline-block; margin-top: 10px; }
        @media print { .no-print { display: none !important; } .chart-container { height: 350px !important; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <div class="mb-4">
            <i class="fas fa-hospital-user fa-4x text-primary mb-3"></i>
            <h3 class="fw-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</h3>
            <p class="text-muted">Dynamic HA Control Chart</p>
        </div>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="mb-3 text-start">
                <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                <select class="form-select" id="inputAgency" required>
                    <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                    <optgroup label="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö">
                        <option value="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)" class="fw-bold text-primary">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)</option>
                    </optgroup>
                    <optgroup label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°">
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.3">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.3</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.4">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.4</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.5">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.5</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.6">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏Å.6</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏≠‡∏≤‡∏û‡∏≤‡∏ò</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© 2+3">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏á‡∏Ü‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© 2+3</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 1">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 1</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 2">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏ò‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÉ‡∏à 2</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏á">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏•‡πà‡∏≤‡∏á</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏ö‡∏ô">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏•‡∏≤‡∏ó‡∏£‡∏ö‡∏ô</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Low Immune ‡∏ò‡∏ô‡∏à.4">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Low Immune ‡∏ò‡∏ô‡∏à.4</option>
                    </optgroup>
                    <optgroup label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°">
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 1">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 1</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 2">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 2</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 3">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 3</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 4">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ä‡∏•‡∏≤‡∏ó‡∏¥‡∏® 4</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.7">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.7</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.8">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏â.8</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.9">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.9</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ú‡∏•‡πÑ‡∏´‡∏°‡πâ">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ú‡∏•‡πÑ‡∏´‡∏°‡πâ</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î</option>
                    </optgroup>
                    <optgroup label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏¥-‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä">
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏£‡∏µ‡πÄ‡∏ß‡∏ä ‡∏ä‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå4</option>
                    </optgroup>
                    <optgroup label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏£‡πå‡πÇ‡∏ò‡∏õ‡∏¥‡∏î‡∏¥‡∏Å‡∏™‡πå">
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ä‡∏≤‡∏¢">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.8">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° Ex.8</option>
                    </optgroup>
                    <optgroup label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÇ‡∏™‡∏ï ‡∏®‡∏≠ ‡∏ô‡∏≤‡∏™‡∏¥‡∏Å ‡∏à‡∏±‡∏Å‡∏©‡∏∏">
                        <option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç EENT ‡πÅ‡∏•‡∏∞‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å ‡∏ä‡∏ß.3">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç EENT ‡πÅ‡∏•‡∏∞‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å ‡∏ä‡∏ß.3</option><option value="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏© EENT">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏© EENT</option>
                    </optgroup>
                </select>
            </div>
            <div class="mb-4 text-start"><label class="form-label fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" class="form-control" id="inputPassword" required placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 1234"></div>
            <button type="submit" class="btn btn-custom w-100 py-2 fs-5">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div class="mt-4 pt-3 border-top text-muted small"><i class="fas fa-code me-1"></i> Developed by <strong>‡∏û‡∏µ‡πà‡∏ó‡∏µ</strong> | <a href="https://oyadata.com" target="_blank" class="text-decoration-none text-muted">oyadata.com</a></div>
        </form>
    </div>
</div>

<div id="mainApp" style="display: none;">
    <div class="container main-container">
        <div class="text-center mb-4 no-print">
            <h1 class="header-title mb-2"><i class="fas fa-layer-group me-2"></i>Dynamic HA Control Chart</h1>
            <div class="agency-badge"><i class="far fa-building me-2"></i><span id="displayAgencyName">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span></div>
            
            <div id="adminFilterContainer" class="admin-filter-box" style="display: none;">
                <label class="form-label fw-bold text-dark mb-1 small"><i class="fas fa-search me-1"></i> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ï‡∏∂‡∏Å</label>
                <select class="form-select form-select-sm border-warning fw-bold" id="adminAgencySelect" onchange="onAdminAgencyChange()">
                    <option value="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">üìä ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                </select>
            </div>

            <div class="mt-3"><button class="btn btn-sm btn-outline-secondary me-2" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>

        <ul class="nav nav-pills justify-content-center mb-4 no-print" id="dynamicTabs" role="tablist"></ul>
        <div class="tab-content" id="dynamicTabContent">
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="d-flex justify-content-between align-items-end mb-3 no-print filter-section">
                    <div style="min-width: 200px;"><label class="form-label fw-bold small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏≤‡∏ü</label><select class="form-select w-100" id="dashboardYearFilter" onchange="updateDashboard()"></select></div>
                    <div class="d-flex gap-2"><button class="btn btn-pdf" onclick="generatePDF()"><i class="fas fa-file-pdf me-2"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button></div>
                </div>
                <div id="pdfExportArea" class="bg-white p-4" style="border-radius: 15px;">
                    <div class="text-center mb-4 d-none d-print-block" id="pdfHeader" style="display: none;"><h2 class="fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</h2><h4 class="text-primary mt-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: <span id="pdfAgencyName"></span></h4><hr></div>
                    <div class="row mb-4" id="dashboardCardsContainer"></div>
                    <div class="card card-custom mb-4" style="box-shadow: none; border: 1px solid #eee;">
                        <div class="card-header card-header-custom text-dark" style="background: #f8f9fa;"><i class="fas fa-chart-area me-2"></i>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</div>
                        <div class="card-body"><div class="chart-container"><canvas id="overviewChart"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="adminSettings" role="tabpanel">
                <div class="card card-custom">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-cogs me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Indicator Settings)</span>
                        <button class="btn btn-warning btn-sm fw-bold" onclick="openIndicatorModal()"><i class="fas fa-plus me-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="indicatorTable">
                                <thead class="table-light"><tr><th>‡∏£‡∏´‡∏±‡∏™ (Code)</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Name)</th><th>‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container credit-footer no-print"><i class="fas fa-laptop-medical me-1"></i> ‡∏£‡∏∞‡∏ö‡∏ö HA Control Chart &copy; <span id="currentYearCredit"></span> | Developed by <strong>‡∏û‡∏µ‡πà‡∏ó‡∏µ</strong></div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="dataForm">
                    <input type="hidden" id="dataId"><input type="hidden" id="dataType"><input type="hidden" id="dataMultiplier">
                    <div class="row"><div class="col-6 mb-3"><label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select class="form-select" id="dataMonth" required><option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option><option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option><option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option><option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option></select></div><div class="col-6 mb-3"><label class="form-label">‡∏õ‡∏µ</label><select class="form-select" id="dataYear" required></select></div></div>
                    <div class="mb-3"><label class="form-label">‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£ (Denominator)</label><input type="number" class="form-control" id="dataDenominator" required min="0"></div>
                    <div class="mb-3"><label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ (Numerator)</label><input type="number" class="form-control" id="dataCases" required min="0"></div>
                    <div class="mb-3"><label class="form-label">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (Rate)</label><input type="text" class="form-control bg-light fw-bold text-primary" id="dataRate" readonly></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="targetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-warning"><h5 class="modal-title text-dark"><i class="fas fa-bullseye me-2"></i>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><input type="hidden" id="targetType"><div class="mb-3"><label class="form-label" id="targetLabel">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><input type="number" class="form-control" id="targetValue" step="0.01" min="0"></div></div>
            <div class="modal-footer"><button type="button" class="btn btn-warning w-100 fw-bold" onclick="saveTarget()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="indicatorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠ (Code)</label><input type="text" class="form-control" id="indCode" required style="text-transform: uppercase;"></div>
                <div class="mb-3"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (Name)</label><input type="text" class="form-control" id="indName" required></div>
                <div class="mb-3"><label class="form-label">‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Multiplier)</label><select class="form-select" id="indMultiplier"><option value="1000">‡∏Ñ‡∏π‡∏ì 1,000</option><option value="100">‡∏Ñ‡∏π‡∏ì 100 (%)</option></select></div>
                <div class="form-check form-switch mt-4"><input class="form-check-input" type="checkbox" id="indStatus" checked><label class="form-check-label fw-bold">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active)</label></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-dark w-100" onclick="saveIndicator()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =========================================================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIPmyGhOxhpENsiDFXttLwJlxS0VlcaZfTkiXF2hGoeK2wcVXONCVeW0lB9CKQ8kr8/exec';
const APP_PASSWORD = '1234'; 
// =========================================================================

document.getElementById('currentYearCredit').textContent = new Date().getFullYear();
const colorPalette = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#f6d365', '#ff0844', '#00c6fb', '#c471ed'];

let allHospitalData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let globalData = [];      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
let globalIndicators = []; 
let chartTargets = {}; 
let charts = {}; 
let dataModal, targetModal, indicatorModal;
const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
const fullMonthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

document.addEventListener('DOMContentLoaded', () => { 
    checkLoginStatus(); 
    dataModal = new bootstrap.Modal(document.getElementById('dataModal')); 
    targetModal = new bootstrap.Modal(document.getElementById('targetModal'));
    indicatorModal = new bootstrap.Modal(document.getElementById('indicatorModal'));
});

function checkLoginStatus() {
    const isLoggedIn = sessionStorage.getItem('ha_logged_in');
    const agencyName = localStorage.getItem('ha_agency_name');
    if (isLoggedIn === 'true' && agencyName) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('displayAgencyName').textContent = agencyName;
        document.getElementById('pdfAgencyName').textContent = agencyName;
        initializeYearSelect(); loadDataFromServer(); 
    }
}

function handleLogin(event) {
    event.preventDefault(); const agency = document.getElementById('inputAgency').value; const password = document.getElementById('inputPassword').value;
    if (password === APP_PASSWORD && agency) {
        sessionStorage.setItem('ha_logged_in', 'true'); localStorage.setItem('ha_agency_name', agency);
        Swal.fire({ icon: 'success', title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', timer: 1000, showConfirmButton: false }).then(() => checkLoginStatus());
    } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
}

function logout() { sessionStorage.removeItem('ha_logged_in'); location.reload(); }

async function loadDataFromServer() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(SCRIPT_URL); const responseData = await response.json();
        
        globalIndicators = responseData.indicators || [];
        chartTargets = responseData.targets || {};
        const currentAgency = localStorage.getItem('ha_agency_name');
        const isAdmin = currentAgency === '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)';
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô allHospitalData
        allHospitalData = (responseData.data || []).map(item => ({
            id: String(item.id || Date.now()), agency: String(item.agency || ''), type: item.type,
            month: parseInt(item.month), year: parseInt(item.year),
            denominator: parseFloat(item.denominator), cases: parseFloat(item.cases), rate: parseFloat(item.rate)
        }));

        if (isAdmin) {
            populateAdminAgencyFilter();
            processDataForView('‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
        } else { 
            processDataForView(currentAgency); 
        }

        buildDynamicUI(); Swal.close();
    } catch (e) { Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); console.error(e); }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏∂‡∏Å‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô Dropdown ‡∏Ç‡∏≠‡∏á Admin
function populateAdminAgencyFilter() {
    const select = document.getElementById('adminAgencySelect');
    document.getElementById('adminFilterContainer').style.display = 'block';

    let agencies = [...new Set(allHospitalData.map(d => d.agency))].filter(a => a && a !== '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•' && a !== '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)');
    agencies.sort();

    select.innerHTML = '<option value="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">üìä ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>';
    agencies.forEach(agency => {
        select.innerHTML += `<option value="${agency}">üè• ${agency}</option>`;
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function processDataForView(selectedAgency) {
    const isAdmin = localStorage.getItem('ha_agency_name') === '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)';

    if (isAdmin && selectedAgency === '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•') {
        let aggregated = {};
        allHospitalData.forEach(d => {
            let key = `${d.type}-${d.year}-${d.month}`;
            if (!aggregated[key]) aggregated[key] = { id: 'admin-'+key, agency: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', type: d.type, month: d.month, year: d.year, denominator: 0, cases: 0, rate: 0 };
            aggregated[key].denominator += d.denominator; aggregated[key].cases += d.cases;
        });
        globalData = Object.values(aggregated).map(d => {
            let ind = globalIndicators.find(i => i.code === d.type); let multi = ind ? ind.multiplier : 1000;
            d.rate = d.denominator > 0 ? (d.cases / d.denominator) * multi : 0; return d;
        });
    } else {
        globalData = allHospitalData.filter(d => d.agency === selectedAgency);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏∂‡∏Å‡πÉ‡∏ô Dropdown
function onAdminAgencyChange() {
    const selected = document.getElementById('adminAgencySelect').value;
    processDataForView(selected);

    document.getElementById('displayAgencyName').textContent = selected === '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)' : `‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${selected}`;
    document.getElementById('pdfAgencyName').textContent = selected === '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•' : selected;

    updateFilterYears();
    const activeIndicators = globalIndicators.filter(i => i.isActive);
    activeIndicators.forEach(ind => { renderTable(ind.code); updateChart(ind.code); });
    updateDashboard();
}

function buildDynamicUI() {
    const tabsUl = document.getElementById('dynamicTabs'); const contentDiv = document.getElementById('dynamicTabContent');
    const isAdmin = localStorage.getItem('ha_agency_name') === '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)';
    
    const oldPanes = contentDiv.querySelectorAll('.dynamic-pane'); oldPanes.forEach(p => p.remove());

    let tabsHtml = `<li class="nav-item"><button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</button></li>`;

    const activeIndicators = globalIndicators.filter(i => i.isActive);

    activeIndicators.forEach((ind, index) => {
        let color = colorPalette[index % colorPalette.length];
        tabsHtml += `<li class="nav-item"><button class="nav-link" id="${ind.code}-tab" data-bs-toggle="pill" data-bs-target="#pane-${ind.code}" type="button" role="tab">${ind.code}</button></li>`;
        
        let actionButtons = isAdmin 
            ? `<button class="btn btn-warning btn-sm fw-bold" onclick="openTargetModal('${ind.code}')"><i class="fas fa-bullseye me-1"></i>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á</button>` 
            : `<button class="btn btn-light btn-sm text-dark" onclick="openModal('${ind.code}')"><i class="fas fa-plus me-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>`;

        let paneHtml = `
        <div class="tab-pane fade dynamic-pane" id="pane-${ind.code}" role="tabpanel">
            <div class="card card-custom">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: ${color}; border-radius: 15px 15px 0 0;">
                    <span class="fw-bold"><i class="fas fa-chart-bar me-2"></i>${ind.code} - ${ind.name}</span><div class="no-print">${actionButtons}</div>
                </div>
                <div class="card-body">
                    <div class="filter-section no-print">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label><select class="form-select" id="yearFilter-${ind.code}" onchange="updateChart('${ind.code}')"></select></div>
                            <div class="col-md-4"><label class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü</label><select class="form-select" id="viewType-${ind.code}" onchange="updateChart('${ind.code}')"><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select></div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chart-${ind.code}"></canvas></div>
                    <div class="table-responsive mt-4">
                        <table class="table table-hover" id="table-${ind.code}">
                            <thead class="table-light"><tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th><th>‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£ (Denominator)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™</th><th>Rate</th><th class="no-print text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>`;
        contentDiv.insertAdjacentHTML('beforeend', paneHtml);
    });

    if (isAdmin) {
        tabsHtml += `<li class="nav-item"><button class="nav-link text-danger fw-bold" id="adminSettings-tab" data-bs-toggle="pill" data-bs-target="#adminSettings" type="button" role="tab"><i class="fas fa-cogs me-1"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button></li>`;
        renderAdminSettings();
    }
    tabsUl.innerHTML = tabsHtml; updateFilterYears();
    activeIndicators.forEach(ind => { renderTable(ind.code); updateChart(ind.code); }); updateDashboard();
}

function renderAdminSettings() {
    const tbody = document.querySelector('#indicatorTable tbody'); tbody.innerHTML = '';
    globalIndicators.forEach(ind => {
        let status = ind.isActive ? '<span class="badge bg-success">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>' : '<span class="badge bg-secondary">‡∏õ‡∏¥‡∏î</span>';
        let multiText = ind.multiplier == 1000 ? 'Rate per 1,000' : '% (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå)';
        tbody.innerHTML += `<tr><td><strong>${ind.code}</strong></td><td>${ind.name}</td><td>${multiText}</td><td>${status}</td><td><button class="btn btn-sm btn-outline-dark" onclick="editIndicator('${ind.code}')"><i class="fas fa-edit"></i></button></td></tr>`;
    });
}

function openIndicatorModal() {
    document.getElementById('indCode').value = ''; document.getElementById('indCode').readOnly = false;
    document.getElementById('indName').value = ''; document.getElementById('indMultiplier').value = '1000'; document.getElementById('indStatus').checked = true;
    indicatorModal.show();
}
function editIndicator(code) {
    let ind = globalIndicators.find(i => i.code === code); if(!ind) return;
    document.getElementById('indCode').value = ind.code; document.getElementById('indCode').readOnly = true; document.getElementById('indName').value = ind.name;
    document.getElementById('indMultiplier').value = ind.multiplier; document.getElementById('indStatus').checked = ind.isActive; indicatorModal.show();
}

async function saveIndicator() {
    let code = document.getElementById('indCode').value.toUpperCase().trim(); let name = document.getElementById('indName').value.trim();
    let multiplier = parseInt(document.getElementById('indMultiplier').value); let isActive = document.getElementById('indStatus').checked;
    if(!code || !name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
    
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
    try {
        await fetch(SCRIPT_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({ action: 'saveIndicator', indicator: { code, name, multiplier, isActive } }) });
        indicatorModal.hide(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadDataFromServer(); 
    } catch(e) { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
}

function initializeYearSelect() {
    let ySelect = document.getElementById('dataYear'); ySelect.innerHTML=''; let cy = new Date().getFullYear();
    for(let y=cy-5; y<=cy+1; y++) ySelect.innerHTML += `<option value="${y}" ${y==cy?'selected':''}>${y}</option>`;
}

function updateFilterYears() {
    const years = [...new Set(globalData.map(d => d.year))].sort((a, b) => b - a);
    if(years.length === 0) years.push(new Date().getFullYear());
    const dashSelect = document.getElementById('dashboardYearFilter');
    if(dashSelect) { let cur = dashSelect.value; dashSelect.innerHTML=''; years.forEach(y => dashSelect.innerHTML += `<option value="${y}">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ${y}</option>`); dashSelect.value = cur || years[0]; }
    globalIndicators.forEach(ind => { let sel = document.getElementById(`yearFilter-${ind.code}`); if(sel) { let cur = sel.value; sel.innerHTML='<option value="all">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>'; years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`); sel.value = cur || 'all'; } });
}

document.getElementById('dataDenominator').addEventListener('input', calculateRate); document.getElementById('dataCases').addEventListener('input', calculateRate);

function calculateRate() {
    let multi = parseInt(document.getElementById('dataMultiplier').value); let den = parseFloat(document.getElementById('dataDenominator').value)||0; let cases = parseFloat(document.getElementById('dataCases').value)||0;
    document.getElementById('dataRate').value = den>0 ? ((cases/den)*multi).toFixed(2) + (multi==100?' %':' /1000') : '';
}

function openModal(type, id=null) {
    let ind = globalIndicators.find(i => i.code === type);
    document.getElementById('dataType').value = type; document.getElementById('dataMultiplier').value = ind.multiplier;
    document.getElementById('modalTitle').textContent = id ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type}` : `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type}`;
    if(id) {
        let d = globalData.find(x => x.id === id);
        document.getElementById('dataId').value=d.id; document.getElementById('dataMonth').value=d.month; document.getElementById('dataYear').value=d.year;
        document.getElementById('dataDenominator').value=d.denominator; document.getElementById('dataCases').value=d.cases; calculateRate();
    } else { document.getElementById('dataForm').reset(); document.getElementById('dataId').value=''; document.getElementById('dataMonth').value=new Date().getMonth()+1; document.getElementById('dataYear').value=new Date().getFullYear(); }
    dataModal.show();
}

async function saveData() {
    let type=document.getElementById('dataType').value, id=document.getElementById('dataId').value;
    let m=parseInt(document.getElementById('dataMonth').value), y=parseInt(document.getElementById('dataYear').value);
    let den=parseFloat(document.getElementById('dataDenominator').value), cases=parseFloat(document.getElementById('dataCases').value);
    if(isNaN(den)||isNaN(cases)) return Swal.fire('‡∏£‡∏∞‡∏ß‡∏±‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç', 'warning');
    let multi = parseInt(document.getElementById('dataMultiplier').value); let rate = den>0 ? (cases/den)*multi : 0;
    
    Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading() });
    try {
        let payload = { action:'save', data: {id:id||Date.now(), agency:localStorage.getItem('ha_agency_name'), type, month:m, year:y, denominator:den, cases, rate} };
        await fetch(SCRIPT_URL, { method:'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body:JSON.stringify(payload) });
        dataModal.hide(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success'); loadDataFromServer();
    } catch(e) { Swal.fire('Error','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
}

function deleteData(id) {
    Swal.fire({ title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', icon:'warning', showCancelButton:true, confirmButtonText:'‡∏•‡∏ö' }).then(async(res)=>{
        if(res.isConfirmed) {
            Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen:()=>Swal.showLoading() });
            await fetch(SCRIPT_URL, { method:'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body:JSON.stringify({action:'delete', id:id}) });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success'); loadDataFromServer();
        }
    });
}

function openTargetModal(type) { document.getElementById('targetType').value=type; document.getElementById('targetValue').value=chartTargets[type]||0; targetModal.show(); }

async function saveTarget() {
    let t=document.getElementById('targetType').value, v=parseFloat(document.getElementById('targetValue').value);
    if(isNaN(v)) return; Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢...', didOpen:()=>Swal.showLoading() });
    try {
        await fetch(SCRIPT_URL, { method:'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body:JSON.stringify({action:'saveTarget', type:t, value:v}) });
        targetModal.hide(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); loadDataFromServer();
    } catch(e) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
}

function renderTable(type) {
    let data = globalData.filter(d => d.type === type).sort((a,b)=> b.year-a.year || b.month-a.month);
    let tbody = document.querySelector(`#table-${type} tbody`); if(!tbody) return; tbody.innerHTML='';
    let ind = globalIndicators.find(i => i.code === type); let suffix = ind.multiplier==100?'%':'/1000';
    let isAdmin = localStorage.getItem('ha_agency_name') === '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡∏≤‡∏á (Admin)';
    
    data.forEach(d => {
        let act = isAdmin ? `<span class="badge bg-secondary">‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>` : `<button class="btn btn-sm btn-outline-primary me-1" onclick="openModal('${type}', '${d.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteData('${d.id}')"><i class="fas fa-trash"></i></button>`;
        tbody.innerHTML += `<tr><td>${fullMonthNames[d.month-1]} ${d.year}</td><td>${d.denominator.toLocaleString()}</td><td>${d.cases}</td><td class="text-primary fw-bold">${d.rate.toFixed(2)}<small class="text-muted ms-1">${suffix}</small></td><td class="text-center no-print">${act}</td></tr>`;
    });
}

function updateChart(type) {
    let canvas = document.getElementById(`chart-${type}`); if(!canvas) return; let ctx = canvas.getContext('2d');
    let view = document.getElementById(`viewType-${type}`).value; let yf = document.getElementById(`yearFilter-${type}`).value;
    let data = globalData.filter(d => d.type === type); if(yf !== 'all') data = data.filter(d => d.year == yf);
    let ind = globalIndicators.find(i => i.code === type); let labels=[], rates=[];
    
    if(view === 'yearly') {
        let yD = {}; data.forEach(d => { if(!yD[d.year]) yD[d.year]={den:0, c:0}; yD[d.year].den+=d.denominator; yD[d.year].c+=d.cases; });
        labels = Object.keys(yD).sort(); rates = labels.map(y => yD[y].den>0 ? (yD[y].c/yD[y].den)*ind.multiplier : 0);
    } else {
        data.sort((a,b)=> a.year-b.year || a.month-b.month); labels = data.map(d => `${monthNames[d.month-1]} ${d.year}`); rates = data.map(d => d.rate);
    }
    
    if(charts[type]) charts[type].destroy(); if(rates.length===0) return;
    let mean = rates.reduce((a,b)=>a+b,0)/rates.length; let sd = Math.sqrt(rates.map(r=>Math.pow(r-mean,2)).reduce((a,b)=>a+b,0)/rates.length)||0;
    let color = colorPalette[globalIndicators.findIndex(i=>i.code===type)%colorPalette.length];
    
    charts[type] = new Chart(ctx, { type: 'line', data: { labels, datasets: [
        { label: 'Rate', data: rates, borderColor: color, backgroundColor: color+'20', fill:true, tension:0.4, borderWidth:3 },
        { label: 'Target', data: Array(labels.length).fill(chartTargets[type]||0), borderColor: '#ff9800', borderDash:[5,5], fill:false },
        { label: 'Mean', data: Array(labels.length).fill(mean), borderColor: '#2196f3', borderDash:[5,5], fill:false },
        { label: 'UCL', data: Array(labels.length).fill(mean+(3*sd)), borderColor: '#f44336', borderDash:[10,5], fill:false }
    ]}, options: { responsive:true, maintainAspectRatio:false } });
}

function updateDashboard() {
    let ySelect = document.getElementById('dashboardYearFilter'); let selY = ySelect ? parseInt(ySelect.value) : new Date().getFullYear();
    let cDiv = document.getElementById('dashboardCardsContainer'); cDiv.innerHTML='';
    let fData = globalData.filter(d => d.year === selY);
    let activeInds = globalIndicators.filter(i => i.isActive); let overviewDatasets = [];

    activeInds.forEach((ind, index) => {
        let color = colorPalette[index % colorPalette.length]; let dInd = fData.filter(d => d.type === ind.code);
        let tDen = dInd.reduce((s,d)=>s+d.denominator,0), tCase = dInd.reduce((s,d)=>s+d.cases,0); let rate = tDen>0 ? (tCase/tDen)*ind.multiplier : 0;
        
        cDiv.innerHTML += `<div class="col-md-3 col-6 mb-3"><div class="stat-card" style="border-left-color:${color};"><div class="stat-number" style="color:${color};">${tCase.toLocaleString()}</div><div class="text-muted">${ind.code} Cases</div><small class="text-success fw-bold">${rate.toFixed(2)} ${ind.multiplier==100?'%':'/1k'}</small></div></div>`;
        overviewDatasets.push({ label: ind.code, borderColor: color, tension: 0.4, data: Array(12).fill(null).map((_,i)=>{ let mD = dInd.find(x=>x.month==i+1); return mD?mD.rate:null; }) });
    });

    let ctx = document.getElementById('overviewChart'); if(charts.overview) charts.overview.destroy();
    charts.overview = new Chart(ctx, { type:'line', data:{ labels:monthNames, datasets:overviewDatasets }, options:{ responsive:true, maintainAspectRatio:false }});
}

function generatePDF() {
    document.getElementById('currentDatePDF').textContent = new Date().toLocaleString('th-TH'); document.getElementById('pdfHeader').style.display='block'; document.getElementById('pdfHeader').classList.remove('d-none');
    Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', didOpen:()=>Swal.showLoading() });
    html2pdf().set({ margin:10, filename:'HA_Report.pdf', jsPDF:{orientation:'landscape'} }).from(document.getElementById('pdfExportArea')).save().then(()=>{ document.getElementById('pdfHeader').style.display='none'; Swal.close(); });
}
</script>
</body>
</html>
